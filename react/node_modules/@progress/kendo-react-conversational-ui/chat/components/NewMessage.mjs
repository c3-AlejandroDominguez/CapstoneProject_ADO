/**
 * @license
 *-------------------------------------------------------------------------------------------
 * Copyright Â© 2025 Progress Software Corporation. All rights reserved.
 * Licensed under commercial license. See LICENSE.md in the package root for more information
 *-------------------------------------------------------------------------------------------
 */
import { classNames as v } from "@progress/kendo-react-common";
import * as e from "react";
import { Button as N, SpeechToTextButton as ue } from "@progress/kendo-react-buttons";
import { Upload as ie } from "@progress/kendo-react-upload";
import { SuggestionGroup as fe } from "./SuggestionsGroup.mjs";
import { InputSuffix as me, TextArea as pe } from "@progress/kendo-react-inputs";
import { xIcon as ge, paperPlaneIcon as de, paperclipIcon as ke } from "@progress/kendo-svg-icons";
import { useChatContext as he } from "./ChatContext.mjs";
import { useLocalization as Ce } from "@progress/kendo-react-intl";
import { getDeletedMessageText as be, isAuthor as xe } from "../utils.mjs";
import { closeReply as _, messages as S, newMessageSendButton as ee, attachFile as te, newMessageMessageInput as ne } from "../../messages/index.mjs";
import Ee from "./elements/FileBox.mjs";
const Se = e.forwardRef((se, ae) => {
  const {
    onSendMessage: T,
    isDirectionRightToLeft: B,
    placeholder: F,
    MessageBox: R,
    suggestions: y,
    onSuggestionClick: oe,
    inputValue: d,
    onInputValueChange: m,
    suggestionTemplate: le,
    sendButtonConfig: D,
    onInputClick: z
  } = se, { replyToMessage: s, setReplyToMessage: k, user: h, messageListScrollContainerRef: f, speechToTextConfig: C, uploadConfig: a } = he(), [L] = e.useState(!1), [o, b] = e.useState(void 0), [l, M] = e.useState([]), [K, A] = e.useState(!1), p = e.useRef(null), w = e.useRef(null), r = Ce(), i = e.useCallback(() => {
    p.current !== null && p.current.focus();
  }, []);
  e.useEffect(() => {
    d !== void 0 && d !== o && (b(d), i());
  }, [d, o, i]), e.useEffect(() => {
    s && i();
  }, [s, i]), e.useLayoutEffect(() => {
    K && (f != null && f.current) && (f.current.scrollTop = f.current.scrollHeight - f.current.clientHeight, A(!1));
  }, [K, f]);
  const P = e.useCallback(
    (t) => {
      const n = t.value;
      b(n), m && m(n);
    },
    [m]
  ), g = e.useMemo(
    () => !!(o != null && o.trim() || a !== !1 && l.length > 0),
    [o, l.length, a]
  ), x = e.useCallback(
    (t) => {
      if (t.preventDefault(), T) {
        const n = o;
        if (g) {
          const c = {
            id: "",
            author: h,
            text: n || "",
            timestamp: /* @__PURE__ */ new Date(),
            replyToId: s ? s.id : void 0,
            files: l.map((u) => ({
              name: u.name,
              size: u.size,
              type: u.extension,
              rawFile: u.getRawFile ? u.getRawFile() : u
            }))
          };
          k(null), T(c, t), M([]), b(""), m && m(""), A(!0);
        }
      }
    },
    [
      T,
      o,
      h,
      s,
      l,
      k,
      m,
      g
    ]
  ), U = e.useCallback(
    (t) => {
      if (!(t.key === "Enter" && t.shiftKey))
        switch (t.key) {
          case "Enter":
            return t.preventDefault(), x(t);
          case "Escape":
            p.current && p.current.blur();
            break;
          default:
            return;
        }
    },
    [x]
  );
  e.useImperativeHandle(
    ae,
    () => ({
      focusInput: i
    }),
    [i]
  );
  const H = e.useCallback((t) => {
    M((n) => n.filter((c) => c.name !== t));
  }, []), V = e.useCallback(() => a === !1 ? null : /* @__PURE__ */ e.createElement(Ee, { files: l, onFileRemove: H, renderInTextarea: !0 }), [l, H, a]), j = e.useCallback(
    (t, n) => t.isDeleted ? be(n, r) : t.text,
    [r]
  ), G = e.useCallback(() => {
    if (s) {
      const t = xe(h, s);
      return /* @__PURE__ */ e.createElement(
        "div",
        {
          className: v(
            "k-message-reference",
            t ? "k-message-reference-sender" : "k-message-reference-receiver"
          )
        },
        /* @__PURE__ */ e.createElement("div", { className: "k-message-reference-content" }, j(s, t)),
        /* @__PURE__ */ e.createElement("span", { className: "k-spacer" }),
        /* @__PURE__ */ e.createElement(
          N,
          {
            fillMode: "flat",
            themeColor: "base",
            svgIcon: ge,
            onClick: () => k(null),
            "aria-label": r.toLanguageString(_, S[_])
          }
        )
      );
    }
    return null;
  }, [s, h, j, k, r]), $ = e.useCallback(
    (t) => {
      try {
        const n = Array.from(t.newState);
        M((c) => [...c, ...n]), i();
      } catch {
      }
    },
    [i]
  ), q = e.useCallback(() => {
    w.current && a !== !1 && w.current.actionElement.click();
  }, [a]), J = e.useCallback((t) => {
  }, []), O = e.useCallback((t) => {
    const { isFinal: n, alternatives: c } = t;
    if (c.length > 0) {
      const u = c[0];
      n && b((E) => (E ? `${E} ` : "") + u.transcript);
    }
  }, []), Q = e.useCallback(() => /* @__PURE__ */ e.createElement(e.Fragment, null, l.length > 0 && V(), s && /* @__PURE__ */ e.createElement("span", { className: "k-input-prefix k-input-prefix-horizontal" }, G())), [l.length, s, V, G]), W = e.useCallback((t) => {
    t.preventDefault();
  }, []), X = e.useCallback((t) => {
    t.key === "Escape" && t.currentTarget.blur();
  }, []), I = e.useMemo(
    () => /* @__PURE__ */ e.createElement(
      N,
      {
        rounded: "full",
        fillMode: "solid",
        themeColor: "primary",
        className: "k-chat-send",
        icon: "paper-plane",
        svgIcon: de,
        onClick: x,
        onMouseDown: W,
        onKeyDown: X,
        "aria-label": r.toLanguageString(ee, S[ee]),
        dir: B ? "rtl" : void 0,
        disabled: !g,
        "aria-disabled": !g,
        ...D
      }
    ),
    [
      x,
      W,
      X,
      r,
      B,
      g,
      D
    ]
  ), Y = e.useCallback(() => {
    const t = typeof C == "object" ? C : void 0, n = typeof a == "object" ? a : {}, { className: c, ...u } = n, E = v("k-hidden", c), re = a !== !1, ce = C !== !1;
    return /* @__PURE__ */ e.createElement(me, null, ce && /* @__PURE__ */ e.createElement(
      ue,
      {
        fillMode: "clear",
        themeColor: "base",
        onError: J,
        onResult: O,
        ...t
      }
    ), re && /* @__PURE__ */ e.createElement(e.Fragment, null, /* @__PURE__ */ e.createElement(
      N,
      {
        key: "attach-file",
        fillMode: "clear",
        themeColor: "base",
        svgIcon: ke,
        onClick: q,
        "aria-label": r.toLanguageString(te, S[te])
      }
    ), /* @__PURE__ */ e.createElement(
      ie,
      {
        ref: w,
        files: l,
        onAdd: $,
        multiple: !0,
        autoUpload: !1,
        ...u,
        className: E
      }
    )), /* @__PURE__ */ e.createElement("span", { className: "k-spacer" }), I);
  }, [
    C,
    a,
    l,
    J,
    O,
    q,
    $,
    r,
    I
  ]), Z = e.useMemo(
    () => /* @__PURE__ */ e.createElement(
      pe,
      {
        className: v("k-message-box", "!k-flex-col", { "k-focus": L }),
        resizable: "none",
        rows: 1,
        placeholder: F,
        value: o,
        onChange: P,
        onKeyDown: U,
        onClick: z,
        prefix: Q,
        suffix: Y,
        ref: p,
        "aria-label": r.toLanguageString(
          ne,
          S[ne]
        )
      }
    ),
    [
      L,
      F,
      o,
      P,
      U,
      z,
      Q,
      Y,
      r
    ]
  );
  return /* @__PURE__ */ e.createElement("div", { className: "k-message-box-wrapper" }, y && y.length > 0 && /* @__PURE__ */ e.createElement(
    fe,
    {
      onSuggestionClick: oe,
      suggestions: y,
      suggestionTemplate: le
    }
  ), R ? /* @__PURE__ */ e.createElement(R, { messageInput: Z, sendButton: I }) : Z);
});
Se.displayName = "NewMessage";
export {
  Se as default
};
